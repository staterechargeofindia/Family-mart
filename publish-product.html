<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Publish Product</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="margin:0;font-family:Arial;background:#f1f3f6">

<!-- ================= HEADER ================= -->
<header style="display:flex;align-items:center;justify-content:space-between;
padding:12px;background:#222;color:white">
  <span onclick="history.back()" style="font-size:22px;cursor:pointer">‚¨ÖÔ∏è</span>
  <b>Publish Product</b>
  <span onclick="location.href='index.html'" style="font-size:22px;cursor:pointer">üè†</span>
</header>

<div style="padding:12px">

<div class="card">

  <h3>Product Details</h3>

  <!-- CATEGORY -->
  <label>Category</label>
  <select id="pcategory" style="width:100%;padding:8px;margin-bottom:8px">
    <option value="">Select Category</option>
  </select>

  <!-- NAME -->
  <label>Product Name</label>
  <input id="pname" placeholder="Product name"
    style="width:100%;padding:8px;margin-bottom:8px">

  <!-- DESCRIPTION -->
  <label>Description</label>
  <textarea id="pdesc" placeholder="Product description"
    style="width:100%;padding:8px;margin-bottom:8px"></textarea>

  <!-- PRICE -->
  <label>Price (Selling)</label>
  <input id="pprice" type="number" placeholder="Selling price"
    oninput="calcDiscount()"
    style="width:100%;padding:8px;margin-bottom:8px">

  <!-- MRP -->
  <label>MRP</label>
  <input id="pmrp" type="number" placeholder="MRP"
    oninput="calcDiscount()"
    style="width:100%;padding:8px;margin-bottom:8px">

  <!-- DISCOUNT -->
  <label>Discount (%)</label>
  <input id="pdiscount" readonly
    style="width:100%;padding:8px;margin-bottom:8px;background:#eee">

  <!-- IMAGES -->
  <label>Product Images (2 required)</label>
  <input type="file" id="img1" accept="image/*"><br><br>
  <input type="file" id="img2" accept="image/*"><br><br>

  <button onclick="publishProduct()">Publish Product</button>

</div>

</div>

<script>
/* LOAD CATEGORIES (ADMIN CONTROLLED) */
const categories = JSON.parse(localStorage.getItem("categories")) || [];
const catSelect = document.getElementById("pcategory");

categories.forEach(c=>{
  const opt=document.createElement("option");
  opt.value=c;
  opt.textContent=c.charAt(0).toUpperCase()+c.slice(1);
  catSelect.appendChild(opt);
});

/* DISCOUNT AUTO CALC */
function calcDiscount(){
  const price = Number(pprice.value);
  const mrp = Number(pmrp.value);
  if(price && mrp && mrp > price){
    const d = Math.round(((mrp - price) / mrp) * 100);
    pdiscount.value = d;
  }else{
    pdiscount.value = 0;
  }
}

/* IMAGE TO BASE64 */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

/* PUBLISH PRODUCT */
async function publishProduct(){

  if(!pcategory.value){
    alert("Select category");
    return;
  }
  if(!pname.value || !pprice.value || !pmrp.value){
    alert("Fill all required fields");
    return;
  }
  if(!img1.files[0] || !img2.files[0]){
    alert("Upload 2 images");
    return;
  }

  const products = JSON.parse(localStorage.getItem("products")) || [];
  const merchant = localStorage.getItem("merchantName") || "Merchant Shop";

  const image1 = await toBase64(img1.files[0]);
  const image2 = await toBase64(img2.files[0]);

  products.push({
    name: pname.value,
    desc: pdesc.value,
    price: Number(pprice.value),
    mrp: Number(pmrp.value),
    discount: Number(pdiscount.value),
    category: pcategory.value,
    merchant: merchant,
    images: [image1, image2]
  });

  localStorage.setItem("products", JSON.stringify(products));

  alert("Product published successfully");
  location.href = "merchant.html";
}
</script>

<style>
.card{
  background:#fff;
  padding:15px;
  border-radius:10px;
}
button{
  width:100%;
  padding:10px;
  background:#2874f0;
  color:white;
  border:none;
  border-radius:6px;
}
label{
  font-size:13px;
  color:#333;
}
</style>

</body>
</html>
